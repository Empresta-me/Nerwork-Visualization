<!DOCTYPE html>
<html>
    <head>
        <title>W3.CSS Template</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
        <style>
            body,h1 {font-family: "Raleway", sans-serif}
            body, html {height: 100%}
            .bgimg {
            background-image: url('/w3images/forestbridge.jpg');
            min-height: 100%;
            background-position: center;
            background-size: cover;
            }
            .links line {
              stroke-opacity: 1;
              stroke-width: 3px;
            }

            .nodes circle {
              stroke: #fff;
              stroke-width: 1.5px;
            }

            .tooltip {
              position: absolute;
              text-align: center;
              padding: 6px;
              font: 12px sans-serif;
              background: #ddd;
              pointer-events: none;
              border-radius: 5px;
              pointer-events: none;
            }
        </style>
    </head>
    <body>

        <div class="bgimg w3-display-container w3-animate-opacity w3-text-black">
        <div class="w3-display-topleft w3-padding-large w3-xlarge">
            EMPRESTA.ME
        </div>
        <div class="w3-display-middle">
            <div id="container"></div>
            <svg id = "mySvg" width="960" height="600"></svg>
        </div>
        </div>
    </body>

    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script>
      //initilize svg or grab svg
      var svg = d3.select("#mySvg");
      var width = svg.attr("width");
      var height = svg.attr("height");

      //intialize data
      var graph = {
        nodes: [
          { name: "Alice", id: 1 , logo: "logos/1.png"},
          { name: "Bob", id: 2, logo: "logos/2.png" },
          { name: "Chen", id: 3, logo: "logos/3.png" },
          { name: "Dawg", id: 4, logo: "logos/4.png" },
          { name: "Ethan", id: 5, logo: "logos/5.png" },
          { name: "Frank", id: 6, logo: "logos/6.png" },
          { name: "George", id: 7, logo: "logos/7.png" },
          { name: "Hanes", id: 8, logo: "logos/8.png" },
          { name: "Ivan", id: 9, logo: "logos/9.png" }
        ],
        links: [
          { source: "Alice", target: "Bob", value: 1 },
          { source: "Bob", target: "Alice", value: 1 },
          { source: "Chen", target: "Bob", value: 1  },
          { source: "Bob", target: "Chen", value: 0},
          { source: "Chen", target: "Dawg", value: 1 },
          { source: "Dawg", target: "Chen", value: 1 },
          { source: "Hanes", target: "Frank", value: 1 },
          { source: "Frank", target: "Hanes", value: 1 },
          { source: "George", target: "Hanes", value: 0 },
          { source: "Hanes", target: "George", value: 1 },
          { source: "Dawg", target: "Ethan", value: 0 },
          { source: "Ethan", target: "Dawg", value: 0 },
          { source: "Ivan", target: "Chen", value: 1},
          { source: "Chen", target: "Ivan", value: 0}
        ]
      };

      var simulation = d3
        .forceSimulation(graph.nodes)
        .force(
          "link",
          d3
            .forceLink()
            .id(function(d) {
              return d.name;
            })
            .links(graph.links)
        )

        .force("charge", d3.forceManyBody().strength(-30))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .on("tick", ticked);

      // Define the div for the tooltip
      var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      var link = svg
        .append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(graph.links, function(d) { return d.source.id + "-" + d.target.id; }) // add identifier
        
        .enter()
        .append("line")
        .on("click", function(d) {
          tooltip.style("display", "block")
          tooltip.transition()
          .duration(200)
          .style("opacity", .9);
          //tooltip.html(d.value)

          // Check the boolean value of the other respective link
          var otherLink = graph.links.filter(function(link) {
            return link.source === d.target && link.target === d.source;
          })[0];
          var otherValue = otherLink.value;
          console.log(d.value)
          console.log(otherValue)
          
          // Set tooltip content based on the boolean value of the other link
          if (d.value === 0 || otherValue === 0) {
            tooltip.html(0);
          } else {
            tooltip.html(1);
          }
        

          tooltip.style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY - 28) + "px");
        })
        // Add mouseout event listener to hide tooltip
        .on("mouseout", function(d) {
        tooltip.style("display", "none");
        })
        ;

      var node = svg
        .append("g")
        .attr("class", "nodes")
        .selectAll("circle")
        .data(graph.nodes)
        .enter()
        .append("circle")
        .attr("r", 5)
        .attr("fill", function(d) {
          return "blue";
        })
        .call(
          d3
            .drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended)
        )
        .on("click", function(d) {
          tooltip.style("display", "block")
          tooltip.transition()
          .duration(200)
          .style("opacity", .9);
          tooltip.html(d.name)
          .style("left", (d3.event.pageX) + "px")
          .style("top", (d3.event.pageY - 28) + "px");
        })
        // Add mouseout event listener to hide tooltip
        .on("mouseout", function(d) {
        tooltip.style("display", "none");
        })
        ;

      function ticked() {
        link
          .attr("x1", function(d) {
            return d.source.x;
          })
          .attr("y1", function(d) {
            return d.source.y;
          })
          .attr("x2", function(d) {
            return d.target.x;
          })
          .attr("y2", function(d) {
            return d.target.y;
          })

          .attr("stroke", function(d) {
            // find duplicate link with opposite value
            var duplicate = graph.links.find(function(l) {
              return l.source.id === d.target.id && l.target.id === d.source.id && l.value !== d.value;
            });
            if (duplicate) {
              return "red";
            } else if (d.value === 1) {
              return "green";
            } else {
              return "red";
            }
          });

        node
          .attr("cx", function(d) {
            return d.x;
          })
          .attr("cy", function(d) {
            return d.y;
          });
      }

      function dragstarted(d) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }

      function dragged(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
      }

      function dragended(d) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    
    </script>
    
    <script>
        // Call your function here
        miserables = FileAttachment("miserables.json").json()
        const chart = ForceGraph(miserables, {
        nodeId: d => d.id,
        nodeGroup: d => d.group,
        nodeTitle: d => `${d.id}\n${d.group}`,
        linkStrokeWidth: l => Math.sqrt(l.value),
        width,
        height: 600,
        invalidation // a promise to stop the simulation when the cell is re-run
        });

        document.getElementById("container").appendChild(chart);
    </script>
</html>
<script>
    const svg = document.getElementById("mySvg");
    svg.append('circle').style('fill', 'red');
</script>



